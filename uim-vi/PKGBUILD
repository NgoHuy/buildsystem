#!/bin/bash

# Maintainer: Anh K. Huynh <kyanh@theslinux.org>
# Original Maintainer: Gaetan Bisson <bisson@archlinux.org>
# Original Contributor: damir <damir@archlinux.org>

pkgdesc='Vietnamese input method library'
url='http://code.google.com/p/uim/'
license=('custom:BSD')
arch=('i686' 'x86_64')
depends=('libxft' 'libedit' 'm17n-lib' 'm17n-db-vi' 'uim-vi-xtelex')
makedepends=('intltool' 'gettext' 'qt4' 'gtk2' 'gtk3' 'm17n-db-vi')
optdepends=('qt4: immodule and helper applications'
            'gtk2: immodule and helper applications'
            'gtk3: immodules and helper applications')
options=('!libtool')

source=("uim-vi.patch"
        "uim-vi-m17n-candidate-window.patch"
        "uim-vi-generic_im_adjustable_default_state.patch"
        "http://uim.googlecode.com/files/uim-${pkgver}.tar.gz"
        "https://raw.github.com/TheSLinux-forks/myquartz-scim2uim/v1.1.0/bin/scim2uim.awk")

provides=('uim')
conflicts=('uim')
replaces=('uim')

install=install

build() {
  cd "${srcdir}/uim-${pkgver}"

  msg "Generating faked 'xtelex.scm'..."
  echo 'A A' | awk -f "${srcdir}/scim2uim.awk" -vim=telex \
    > "./scm/xtelex.scm"

  msg "Generating faked 'xvni.scm'..."
  echo 'A A' | awk -f "${srcdir}/scim2uim.awk" -vim=vni \
    > "./scm/xvni.scm"

  for _file in xtelex.png xtelex.svg xvni.png xvni.svg; do
    touch "./pixmaps/${_file}"
  done

  patch -Np4 < "${srcdir}/uim-vi.patch"
  patch -Np4 < "${srcdir}/uim-vi-generic_im_adjustable_default_state.patch"
  patch -l -Np4 < "${srcdir}/uim-vi-m17n-candidate-window.patch"

  ./autogen.sh
  ./configure \
    --prefix=/usr \
    --libexecdir=/usr/lib/uim \
    --without-anthy \
    --with-qt4-immodule \
    --with-qt4 \
    --disable-gnome-applet \
    --disable-dict \
    --without-skk \
    --without-mana \
    --without-prime \
    --without-sj3 \
    --without-scim \
    --without-eb \
    --without-osx-dcs \
    --without-sqlite3

  make
}

package() {
  cd "${srcdir}/uim-${pkgver}"
  make DESTDIR="${pkgdir}" install
  rm "${pkgdir}"/usr/lib/libgcroots.a
  install -D -m644 COPYING "${pkgdir}/usr/share/licenses/uim/COPYING"
  rm -f "${pkgdir}/usr/share/uim/"{xtelex,xvni}.scm
  rm -f "${pkgdir}/usr/share/uim/pixmaps/"{xtelex,xvni}.{svg,png}
  ln -s uim-pref-gtk "${pkgdir}/usr/bin/uim-setup"
  ln -s uim-toolbar-gtk-systray "${pkgdir}/usr/bin/uim-systray"
}
