From b3496974cf6ec83c8f17e9c268cdd7220d48023d Mon Sep 17 00:00:00 2001
From: Ky-Anh Huynh <kyanh@theslinux.org>
Date: Tue, 16 Apr 2013 21:47:16 +0000
Subject: [PATCH 1/3] Allow some package information to be fetched externally

The original "makepkg" will reset all package information, and that diasllows
to support some hooks (no we do not have any hook when using PKGBUILD.)
---
 scripts/makepkg.sh.in | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/scripts/makepkg.sh.in b/scripts/makepkg.sh.in
index da620a4..389dee7 100644
--- a/scripts/makepkg.sh.in
+++ b/scripts/makepkg.sh.in
@@ -2733,6 +2733,11 @@ unset pkgname pkgbase pkgver pkgrel epoch pkgdesc url license groups provides
 unset md5sums replaces depends conflicts backup source install changelog build
 unset makedepends optdepends options noextract
 
+pkgname="${PACKAGE_NAME:-}"
+pkgver="${PACKAGE_VERSION:-}"
+pkgrel="${PACKAGE_RELEASE:-}"
+pkgbase="${PACKAGE_BASE:-}"
+
 BUILDFILE=${BUILDFILE:-$BUILDSCRIPT}
 if [[ ! -f $BUILDFILE ]]; then
 	if [[ -t 0 ]]; then
-- 
1.8.2.1


From d7660c50e5556f72a603fbbe132e2c66c9364b9e Mon Sep 17 00:00:00 2001
From: Ky-Anh Huynh <kyanh@theslinux.org>
Date: Sat, 20 Apr 2013 16:55:36 +0700
Subject: [PATCH 2/3] Accept checksum (512) from environment

---
 scripts/makepkg.sh.in | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/scripts/makepkg.sh.in b/scripts/makepkg.sh.in
index 389dee7..b887819 100644
--- a/scripts/makepkg.sh.in
+++ b/scripts/makepkg.sh.in
@@ -2738,6 +2738,10 @@ pkgver="${PACKAGE_VERSION:-}"
 pkgrel="${PACKAGE_RELEASE:-}"
 pkgbase="${PACKAGE_BASE:-}"
 
+if [[ -n "${PACKAGE_SHA512SUMS}" ]]; then
+	sha512sums=("${PACKAGE_SHA512SUMS[@]}")
+fi
+
 BUILDFILE=${BUILDFILE:-$BUILDSCRIPT}
 if [[ ! -f $BUILDFILE ]]; then
 	if [[ -t 0 ]]; then
-- 
1.8.2.1


From 44673828f3c922ec8da08e3effa8f49318f9789f Mon Sep 17 00:00:00 2001
From: Ky-Anh Huynh <kyanh@theslinux.org>
Date: Sat, 20 Apr 2013 17:11:18 +0700
Subject: [PATCH 3/3] pkgbase will define the behavior

As "pkgbase" is a string, while "pkgname" may be an array,
we can only get "pkgbase" from environment.
---
 scripts/makepkg.sh.in | 12 +++++++++++-
 1 file changed, 11 insertions(+), 1 deletion(-)

diff --git a/scripts/makepkg.sh.in b/scripts/makepkg.sh.in
index b887819..b1eb313 100644
--- a/scripts/makepkg.sh.in
+++ b/scripts/makepkg.sh.in
@@ -2733,7 +2733,6 @@ unset pkgname pkgbase pkgver pkgrel epoch pkgdesc url license groups provides
 unset md5sums replaces depends conflicts backup source install changelog build
 unset makedepends optdepends options noextract
 
-pkgname="${PACKAGE_NAME:-}"
 pkgver="${PACKAGE_VERSION:-}"
 pkgrel="${PACKAGE_RELEASE:-}"
 pkgbase="${PACKAGE_BASE:-}"
@@ -2765,6 +2764,17 @@ else
 	source_safe "$BUILDFILE"
 fi
 
+# There are some cases
+#   PACKAGE_BASE is unset:
+#     `pkgname`, `pkgbase` will be from `PKGBUILD`
+#
+#   PACKAGE_BASE is set:
+#     `pkgbase` is defined
+#     `pkgname` will be `pkgbase` if `pkgname` is unset
+#
+if [[ -z "$pkgname" ]]; then
+	pkgname="$pkgbase"
+fi
 # set defaults if they weren't specified in buildfile
 pkgbase=${pkgbase:-${pkgname[0]}}
 epoch=${epoch:-0}
-- 
1.8.2.1

