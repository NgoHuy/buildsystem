From efa864096449f6f22ad84e825f24d854f0781216 Mon Sep 17 00:00:00 2001
From: Ky-Anh Huynh <kyanh@theslinux.org>
Date: Tue, 16 Apr 2013 21:47:16 +0000
Subject: [PATCH 1/5] Allow some package information to be fetched externally

The original "makepkg" will reset all package information, and that diasllows
to support some hooks (no we do not have any hook when using PKGBUILD.)
---
 pacman/src/pacman-4.1.0/scripts/makepkg.sh.in | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/pacman/src/pacman-4.1.0/scripts/makepkg.sh.in b/pacman/src/pacman-4.1.0/scripts/makepkg.sh.in
index da620a4..389dee7 100644
--- a/pacman/src/pacman-4.1.0/scripts/makepkg.sh.in
+++ b/pacman/src/pacman-4.1.0/scripts/makepkg.sh.in
@@ -2733,6 +2733,11 @@ unset pkgname pkgbase pkgver pkgrel epoch pkgdesc url license groups provides
 unset md5sums replaces depends conflicts backup source install changelog build
 unset makedepends optdepends options noextract
 
+pkgname="${PACKAGE_NAME:-}"
+pkgver="${PACKAGE_VERSION:-}"
+pkgrel="${PACKAGE_RELEASE:-}"
+pkgbase="${PACKAGE_BASE:-}"
+
 BUILDFILE=${BUILDFILE:-$BUILDSCRIPT}
 if [[ ! -f $BUILDFILE ]]; then
 	if [[ -t 0 ]]; then
-- 
1.8.2.1


From e01c9a40f396348573a4a709032dc1f7a25a92ed Mon Sep 17 00:00:00 2001
From: Ky-Anh Huynh <kyanh@theslinux.org>
Date: Sat, 20 Apr 2013 16:55:36 +0700
Subject: [PATCH 2/5] Accept checksum (512) from environment

---
 pacman/src/pacman-4.1.0/scripts/makepkg.sh.in | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/pacman/src/pacman-4.1.0/scripts/makepkg.sh.in b/pacman/src/pacman-4.1.0/scripts/makepkg.sh.in
index 389dee7..b887819 100644
--- a/pacman/src/pacman-4.1.0/scripts/makepkg.sh.in
+++ b/pacman/src/pacman-4.1.0/scripts/makepkg.sh.in
@@ -2738,6 +2738,10 @@ pkgver="${PACKAGE_VERSION:-}"
 pkgrel="${PACKAGE_RELEASE:-}"
 pkgbase="${PACKAGE_BASE:-}"
 
+if [[ -n "${PACKAGE_SHA512SUMS}" ]]; then
+	sha512sums=("${PACKAGE_SHA512SUMS[@]}")
+fi
+
 BUILDFILE=${BUILDFILE:-$BUILDSCRIPT}
 if [[ ! -f $BUILDFILE ]]; then
 	if [[ -t 0 ]]; then
-- 
1.8.2.1


From ba7d6b9371e49a24631d135d31fa44bbb2c0f66b Mon Sep 17 00:00:00 2001
From: Ky-Anh Huynh <kyanh@theslinux.org>
Date: Sat, 20 Apr 2013 17:11:18 +0700
Subject: [PATCH 3/5] pkgbase will define the behavior

As "pkgbase" is a string, while "pkgname" may be an array,
we can only get "pkgbase" from environment.
---
 pacman/src/pacman-4.1.0/scripts/makepkg.sh.in | 12 +++++++++++-
 1 file changed, 11 insertions(+), 1 deletion(-)

diff --git a/pacman/src/pacman-4.1.0/scripts/makepkg.sh.in b/pacman/src/pacman-4.1.0/scripts/makepkg.sh.in
index b887819..b1eb313 100644
--- a/pacman/src/pacman-4.1.0/scripts/makepkg.sh.in
+++ b/pacman/src/pacman-4.1.0/scripts/makepkg.sh.in
@@ -2733,7 +2733,6 @@ unset pkgname pkgbase pkgver pkgrel epoch pkgdesc url license groups provides
 unset md5sums replaces depends conflicts backup source install changelog build
 unset makedepends optdepends options noextract
 
-pkgname="${PACKAGE_NAME:-}"
 pkgver="${PACKAGE_VERSION:-}"
 pkgrel="${PACKAGE_RELEASE:-}"
 pkgbase="${PACKAGE_BASE:-}"
@@ -2765,6 +2764,17 @@ else
 	source_safe "$BUILDFILE"
 fi
 
+# There are some cases
+#   PACKAGE_BASE is unset:
+#     `pkgname`, `pkgbase` will be from `PKGBUILD`
+#
+#   PACKAGE_BASE is set:
+#     `pkgbase` is defined
+#     `pkgname` will be `pkgbase` if `pkgname` is unset
+#
+if [[ -z "$pkgname" ]]; then
+	pkgname="$pkgbase"
+fi
 # set defaults if they weren't specified in buildfile
 pkgbase=${pkgbase:-${pkgname[0]}}
 epoch=${epoch:-0}
-- 
1.8.2.1


From 7b4d4760708f322d1208929bdae31fa25335c703 Mon Sep 17 00:00:00 2001
From: Ky-Anh Huynh <kyanh@theslinux.org>
Date: Sun, 28 Apr 2013 13:33:42 +0700
Subject: [PATCH 4/5] makepkg accepts PACKAGE_FEATURE

This variable is used to control some feature of output filename,
and of the package information
---
 pacman/src/pacman-4.1.0/scripts/makepkg.sh.in | 34 ++++++++++++++++++---------
 1 file changed, 23 insertions(+), 11 deletions(-)

diff --git a/pacman/src/pacman-4.1.0/scripts/makepkg.sh.in b/pacman/src/pacman-4.1.0/scripts/makepkg.sh.in
index b1eb313..9a9ca35 100644
--- a/pacman/src/pacman-4.1.0/scripts/makepkg.sh.in
+++ b/pacman/src/pacman-4.1.0/scripts/makepkg.sh.in
@@ -91,6 +91,13 @@ FORCE_VER=""
 
 PACMAN_OPTS=
 
+# Return the feature string to used in filename
+if [[ -n "$PACKAGE_FEATURE" ]]; then
+	_FEATURE_STRING="-$PACKAGE_FEATURE"
+else
+	_FEATURE_STRING=""
+fi
+
 shopt -s extglob
 
 ### SUBROUTINES ###
@@ -139,7 +146,6 @@ trap_exit() {
 	kill "-$signal" "$$"
 }
 
-
 ##
 # Clean up function. Called automatically when the script exits.
 ##
@@ -176,7 +182,7 @@ clean_up() {
 
 			# clean up dangling symlinks to packages
 			for pkg in ${pkgname[@]}; do
-				for file in ${pkg}-*-*-*{${PKGEXT},${SRCEXT}}; do
+				for file in ${pkg}${_FEATURE_STRING}-*-*-*{${PKGEXT},${SRCEXT}}; do
 					if [[ -h $file && ! -e $file ]]; then
 						rm -f "$file"
 					fi
@@ -1797,7 +1803,7 @@ write_pkginfo() {
 	printf "# Generated by makepkg %s\n" "$makepkg_version"
 	(( INFAKEROOT )) && printf "# using %s\n" "$(fakeroot -v)"
 	printf "# %s\n" "$(LC_ALL=C date -u)"
-	printf "pkgname = %s\n" "$pkgname"
+	printf "pkgname = %s\n" "$pkgname${_FEATURE_STRING}"
 	(( SPLITPKG )) && printf "pkgbase = %s\n" "$pkgbase"
 	printf "pkgver = %s\n" "$(get_full_version)"
 	printf "pkgdesc = %s\n" "${pkgdesc//+([[:space:]])/ }"
@@ -1810,6 +1816,12 @@ write_pkginfo() {
 	mapfile -t provides < <(find_libprovides)
 	mapfile -t depends < <(find_libdepends)
 
+	if [[ -n "$PACKAGE_FEATURE" ]]; then
+		conflicts=("${conflicts[@]}" "$pkgname")
+		provides=("${provides[@]}" "$pkgname")
+		replaces=("${replaces[@]}" "$pkgname")
+	fi
+
 	[[ $license ]]      && printf "license = %s\n"     "${license[@]}"
 	[[ $replaces ]]     && printf "replaces = %s\n"    "${replaces[@]}"
 	[[ $groups ]]       && printf "group = %s\n"       "${groups[@]}"
@@ -1867,7 +1879,7 @@ create_package() {
 
 	# tar it up
 	local fullver=$(get_full_version)
-	local pkg_file="$PKGDEST/${pkgname}-${fullver}-${pkgarch}${PKGEXT}"
+	local pkg_file="$PKGDEST/${pkgname}${_FEATURE_STRING}-${fullver}-${pkgarch}${PKGEXT}"
 	local ret=0
 
 	[[ -f $pkg_file ]] && rm -f "$pkg_file"
@@ -2060,10 +2072,10 @@ install_package() {
 	for pkg in ${pkgname[@]}; do
 		fullver=$(get_full_version $pkg)
 		pkgarch=$(get_pkg_arch $pkg)
-		pkglist+=("$PKGDEST/${pkg}-${fullver}-${pkgarch}${PKGEXT}")
+		pkglist+=("$PKGDEST/${pkg}${_FEATURE_STRING}-${fullver}-${pkgarch}${PKGEXT}")
 
-		if [[ -f "$PKGDEST/${pkg}-debug-${fullver}-${pkgarch}${PKGEXT}" ]]; then
-			pkglist+=("$PKGDEST/${pkg}-debug-${fullver}-${pkgarch}${PKGEXT}")
+		if [[ -f "$PKGDEST/${pkg}${_FEATURE_STRING}-debug-${fullver}-${pkgarch}${PKGEXT}" ]]; then
+			pkglist+=("$PKGDEST/${pkg}${_FEATURE_STRING}-debug-${fullver}-${pkgarch}${PKGEXT}")
 		fi
 	done
 
@@ -2351,7 +2363,7 @@ check_build_status() {
 	if (( ! SPLITPKG )); then
 		fullver=$(get_full_version)
 		pkgarch=$(get_pkg_arch)
-		if [[ -f $PKGDEST/${pkgname}-${fullver}-${pkgarch}${PKGEXT} ]] \
+		if [[ -f $PKGDEST/${pkgname}${_FEATURE_STRING}-${fullver}-${pkgarch}${PKGEXT} ]] \
 				 && ! (( FORCE || SOURCEONLY || NOBUILD )); then
 			if (( INSTALL )); then
 				warning "$(gettext "A package has already been built, installing existing package...")"
@@ -2368,7 +2380,7 @@ check_build_status() {
 		for pkg in ${pkgname[@]}; do
 			fullver=$(get_full_version $pkg)
 			pkgarch=$(get_pkg_arch $pkg)
-			if [[ -f $PKGDEST/${pkg}-${fullver}-${pkgarch}${PKGEXT} ]]; then
+			if [[ -f $PKGDEST/${pkg}${_FEATURE_STRING}-${fullver}-${pkgarch}${PKGEXT} ]]; then
 				somepkgbuilt=1
 			else
 				allpkgbuilt=0
@@ -2892,7 +2904,7 @@ if (( INFAKEROOT )); then
 fi
 
 fullver=$(get_full_version)
-msg "$(gettext "Making package: %s")" "$pkgbase $fullver ($(date))"
+msg "$(gettext "Making package: %s")" "$pkgbase${_FEATURE_STRING} $fullver ($(date))"
 
 if (( !PKGFUNC && !SPLITPKG )); then
 	warning "$(gettext "Using a %s without a %s function is deprecated.")" "$BUILDSCRIPT" "package()"
@@ -3043,7 +3055,7 @@ else
 fi
 
 fullver=$(get_full_version)
-msg "$(gettext "Finished making: %s")" "$pkgbase $fullver ($(date))"
+msg "$(gettext "Finished making: %s")" "$pkgbase${_FEATURE_STRING} $fullver ($(date))"
 
 install_package
 
-- 
1.8.2.1


From c959fe92ac35a7be2563f8dc42a25d10f7337575 Mon Sep 17 00:00:00 2001
From: Ky-Anh Huynh <kyanh@theslinux.org>
Date: Sun, 28 Apr 2013 16:31:59 +0700
Subject: [PATCH 5/5] Add PACKAGE_FEATURE to some output message

---
 pacman/src/pacman-4.1.0/scripts/makepkg.sh.in | 9 +++++----
 1 file changed, 5 insertions(+), 4 deletions(-)

diff --git a/pacman/src/pacman-4.1.0/scripts/makepkg.sh.in b/pacman/src/pacman-4.1.0/scripts/makepkg.sh.in
index 9a9ca35..08dc94d 100644
--- a/pacman/src/pacman-4.1.0/scripts/makepkg.sh.in
+++ b/pacman/src/pacman-4.1.0/scripts/makepkg.sh.in
@@ -1857,7 +1857,7 @@ create_package() {
 	fi
 
 	cd_safe "$pkgdir"
-	msg "$(gettext "Creating package \"%s\"...")" "$pkgname"
+	msg "$(gettext "Creating package \"%s\"...")" "$pkgname${PACKAGE_FEATURE}"
 
 	pkgarch=$(get_pkg_arch)
 
@@ -1953,7 +1953,7 @@ create_debug_package() {
 	fi
 
 	depends=("$pkgname=$(get_full_version)")
-	pkgdesc="Detached debugging symbols for $pkgname"
+	pkgdesc="Detached debugging symbols for $pkgname${PACKAGE_FEATURE}"
 	pkgname=$pkgname-@DEBUGSUFFIX@
 
 	unset groups optdepends provides conflicts replaces backup install changelog
@@ -2060,7 +2060,7 @@ install_package() {
 	(( ! INSTALL )) && return
 
 	if (( ! SPLITPKG )); then
-		msg "$(gettext "Installing package %s with %s...")" "$pkgname" "$PACMAN -U"
+		msg "$(gettext "Installing package %s with %s...")" "$pkgname${PACKAGE_FEATURE}" "$PACMAN -U"
 	else
 		msg "$(gettext "Installing %s package group with %s...")" "$pkgbase" "$PACMAN -U"
 	fi
@@ -2098,9 +2098,10 @@ check_sanity() {
 
 	for i in "${pkgname[@]}"; do
 		if [[ ${i:0:1} = "-" ]]; then
-			error "$(gettext "%s is not allowed to start with a hyphen.")" "pkgname"
+			error "$(gettext "%s is not allowed to start with a hyphen.")" "pkgname${PACKAGE_FEATURE}"
 			ret=1
 		fi
+		# FIXME: Possibly has problem with PACKAGE_FEATURE
 		if [[ $i = *[^[:alnum:]+_.@-]* ]]; then
 			error "$(gettext "%s contains invalid characters: '%s'")" \
 					'pkgname' "${pkgname//[[:alnum:]+_.@-]}"
-- 
1.8.2.1

