# Maintainer: Anh K. Huynh <kyanh@theslinux.org>

# Original Maintainer: Angel Velasquez <angvp@archlinux.org>
# Original Contributor: St√©phane Gaudreault <stephane@archlinux.org>
# Original Contributor: Paul Mattal <paul@archlinux.org>
# Original Contributor: Jason Chu <jason@archlinux.org>

pkgdesc="A Modern Concurrent Version Control System"
arch=('i686' 'x86_64')
url="http://subversion.apache.org/"
license=('APACHE')
depends=('sqlite' 'file' 'serf')
makedepends=('perl' 'libgnome-keyring' 'kdelibs')
optdepends=('libgnome-keyring: for GNOME Keyring for auth credentials'
            'kdeutils-kwallet: for KWallet for auth credentials'
            'bash-completion: for svn bash completion'
            'python2: for some hook scripts'
            'ruby: for some hook scripts')
provides=('svn')
#backup=('etc/xinetd.d/svn' 'etc/conf.d/svnserve')
options=('!makeflags' '!libtool' '!emptydirs')
install=subversion.install
source=(http://www.apache.org/dist/subversion/subversion-${PACKAGE_VERSION}.tar.bz2{,.asc}
        subversion.rpath.fix.patch)

prepare() {
   cd ${pkgname}-${pkgver}
   patch -Np0 -i ../subversion.rpath.fix.patch
   sed -i 's|/usr/bin/env python|/usr/bin/env python2|' tools/hook-scripts/{,mailer/{,tests/}}*.py
}

build() {
   cd ${pkgname}-${pkgver}
   export PYTHON=/usr/bin/python2
   # NOTE: if you are using rvm, this will really help.
   export RUBY=/usr/bin/ruby
   ./configure \
      --prefix=/usr \
      --with-apr=/usr \
      --with-apr-util=/usr \
      --with-zlib=/usr \
      --with-sqlite=/usr \
      --without-serf \
      --with-berkeley-db=:/usr/include/:/usr/lib:db-5.3 \
      --with-gnome-keyring \
      --with-kwallet \
      --disable-static \
      --disable-keychain \
      --disable-plaintext-password-storage \

   make LT_LDFLAGS="-L$Fdestdir/usr/lib"
   #make swig_pydir=/usr/lib/python2.7/site-packages/libsvn \
   #  swig_pydir_extra=/usr/lib/python2.7/site-packages/svn swig-py swig-pl javahl swig-rb
}

# FIXME: this check will not work. On the latest ABS version for
# FIXME: subversion-1.8.3 (abs revision 195040), this (check) is commented
# FIXME: out. It's a bit weird. I dediced to comment this out too, and
# FIXME: add FIXME entries so we will take a look at this in the future.
# FIXME: -- Anh K. Huynh 2013 Sep 25th
# check() {
#    cd ${pkgname}-${pkgver}
#    export LANG=C LC_ALL=C
#    #make check check-swig-pl check-swig-py check-swig-rb CLEANUP=yes # check-javahl
#    make check CLEANUP=yes
# }

package() {
   cd ${pkgname}-${pkgver}

   export LD_LIBRARY_PATH="${pkgdir}"/usr/lib:${LD_LIBRARY_PATH}
   make DESTDIR="${pkgdir}" INSTALLDIRS=vendor \
     install

   install -dm755 "${pkgdir}"/usr/share/subversion
   cp -a tools/hook-scripts "${pkgdir}"/usr/share/subversion/
   rm "${pkgdir}"/usr/share/subversion/hook-scripts/*.in

   ## svnserve ...

   # xinetd
   #install -D -m 644 "${srcdir}"/svn "${pkgdir}"/etc/xinetd.d/svn

   # ... systemd
   #install -D -m 644 "${srcdir}"/svnserve.service  "${pkgdir}"/usr/lib/systemd/system/svnserve.service
   #install -D -m 644 "${srcdir}"/svnserve.tmpfiles "${pkgdir}"/usr/lib/tmpfiles.d/svnserve.conf

   # ... common config
   #install -D -m 644 "${srcdir}"/svnserve.conf "${pkgdir}"/etc/conf.d/svnserve

   install -Dm 644 tools/client-side/bash_completion \
     "${pkgdir}"/usr/share/bash-completion/completions/subversion
   for i in svn svnadmin svndumpfilter svnlook svnsync svnversion; do
      ln -sf subversion "${pkgdir}"/usr/share/bash-completion/completions/${i}
   done
}
